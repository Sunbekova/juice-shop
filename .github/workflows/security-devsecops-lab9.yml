name: CI â€” Build + SAST + SCA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-security:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build project
        run: |
          npm run build || true   # allow failure if build scripts differ

      #### Start a local SonarQube docker container ####
      - name: Start SonarQube (Docker)
        run: |
          docker run -d --rm --name sonarqube -p 9000:9000 sonarqube:lts
          # Wait for SonarQube HTTP port to be available (max 3 minutes)
          end=$((SECONDS+180))
          until curl -sSf http://localhost:9000/ > /dev/null; do
            sleep 5
            if [ $SECONDS -ge $end ]; then
              echo "SonarQube did not become available in time" >&2
              docker logs sonarqube || true
              exit 1
            fi
          done
          echo "SonarQube is up"

      - name: Run SonarScanner
        # use sonar-scanner docker image to avoid installing cli
        run: |
          docker run --rm \
            -e SONAR_HOST_URL="http://host.docker.internal:9000" \
            -v "${{ github.workspace }}":/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=juice-shop-ci \
            -Dsonar.sources=/usr/src \
            -Dsonar.host.url=http://host.docker.internal:9000 \
            -Dsonar.login=admin \
            -Dsonar.password=admin \
            -Dsonar.language=js \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info || true
        # we allow sonar-scanner to exit non-zero in CI for demo; adjust policy as needed

      - name: Save Sonar scanner log
        run: |
          # collect docker logs as a fallback into a file
          docker logs sonarqube > sonar-scan.log || true

      #### Run Semgrep (SAST) ####
      - name: Install Semgrep
        run: |
          python3 -m pip install --user semgrep
          export PATH="$HOME/.local/bin:$PATH"
          semgrep --version

      - name: Run Semgrep
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          semgrep --config=auto --json --output semgrep-report.json .

      #### Run Trivy (SCA) ####
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.0.1_Linux-64bit.tar.gz -O /tmp/trivy.tar.gz || true
          # fallback to apt-get install trivy if available
          if ! command -v trivy >/dev/null 2>&1; then
            sudo apt-get install -y trivy || true
          fi
          trivy --version || true

      - name: Run Trivy filesystem scan (SCA)
        run: |
          # scan the repository filesystem for known vulnerable packages
          trivy fs --format json --output trivy-report.json .

      #### Upload artifacts (reports) ####
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            semgrep-report.json
            trivy-report.json
            sonar-scan.log
