name: CI — Build + SAST + SCA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-security:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build project
        run: |
          npm run build || true   # allow build differences in Juice Shop

      #### Start SonarQube container (SAST) ####
      - name: Start SonarQube (Docker)
        run: |
          docker run -d --rm --name sonarqube -p 9000:9000 sonarqube:lts
          echo "Waiting for SonarQube to be ready..."
          end=$((SECONDS+180))
          until curl -sSf http://localhost:9000/ > /dev/null; do
            sleep 5
            if [ $SECONDS -ge $end ]; then
              echo "SonarQube did not become ready in time" >&2
              docker logs sonarqube || true
              exit 1
            fi
          done
          echo "✅ SonarQube is up and running."

      - name: Run SonarScanner
        run: |
          docker run --rm \
            -e SONAR_HOST_URL="http://host.docker.internal:9000" \
            -v "${{ github.workspace }}":/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=juice-shop-ci \
            -Dsonar.sources=/usr/src \
            -Dsonar.host.url=http://host.docker.internal:9000 \
            -Dsonar.login=admin \
            -Dsonar.password=admin \
            -Dsonar.language=js || true

      - name: Save SonarQube logs
        run: docker logs sonarqube > sonar-scan.log || true

      #### Run Semgrep (SAST) ####
      - name: Install Semgrep
        run: |
          python3 -m pip install --user semgrep
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          semgrep --version

      - name: Run Semgrep
        run: semgrep --config=auto --json --output semgrep-report.json .

      #### Run Trivy (SCA) ####
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          if ! command -v trivy >/dev/null 2>&1; then
            wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.58.0_Linux-64bit.tar.gz -O /tmp/trivy.tar.gz
            tar -xzf /tmp/trivy.tar.gz -C /usr/local/bin trivy
          fi
          trivy --version

      - name: Run Trivy filesystem scan
        run: |
          trivy fs --format json --output trivy-report.json .

      #### Verify and upload artifacts ####
      - name: Check reports before upload
        run: |
          echo "===== FILES IN WORKSPACE ====="
          ls -lah
          echo "===== Checking expected reports ====="
          ls -lah semgrep-report.json || echo "Semgrep report not found"
          ls -lah trivy-report.json || echo "Trivy report not found"
          ls -lah sonar-scan.log || echo "Sonar log not found"

      - name: Upload all reports (even if partial)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            **/*.json
            **/*.log
